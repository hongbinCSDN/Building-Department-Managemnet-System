@model MWMS2.Areas.MWProcessing.Models.Fn01LM_ModModel

<div id="navigator" class="w3-container w3-round-medium ">Application Info</div>
<form id="inputForm" method="post">
    <div id="searchCriteria">
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">DSN :</div>
                <div class="w3-col l2 m12 s12">
                    @Html.TextBoxFor(model => model.P_MW_MODIFICATION.DSN, new { @id = "DSN" })
                    @*<input type="text" />*@
                </div>
                <div class="w3-col l2 m12 s12">Email Address :</div>
                <div class="w3-col l3 m12 s12">
                    @Html.TextBoxFor(model => model.P_MW_MODIFICATION.EMAIL, new { @id = "EMAIL" })
                    @*<input type="text" />*@
                </div>
            </div>
        </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">Mod. Ref. No :</div>
                <div class="w3-col l2 m12 s12">
                    @*@Html.TextBoxFor(model => model.P_MW_MODIFICATION.REFERENCE_NO, new { @id = "REFERENCE_NO" })*@
                    <span id="ModRefNo"></span>
                    @Html.HiddenFor(m => m.P_MW_MODIFICATION.REFERENCE_NO, new { id = "refNo" })
                </div>
            </div>
        </div>

        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">Form No. :</div>
                <div class="w3-col l2 m12 s12">
                    <span id="FormNoLb"></span>
                    @Html.HiddenFor(m => m.P_MW_MODIFICATION.FORM_NO, new { id = "FormNo" })
                </div>
            </div>
        </div>

        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">MW Ref No :</div>
                <div class="w3-col l4 m12 s12" style="position:relative">
                    <div id="AddPanel" class="w3-col l6 m6 s6">
                        <input type="text" id="MwRefNo" name="MwRefNo1" />
                        <input type="text" id="MwRefNo" name="MwRefNo2" />
                        <input type="text" id="MwRefNo" name="MwRefNo3" />
                    </div>
                    <div class="w3-col l6 m6 s6" style="position:absolute;float:left;width:50%;bottom:0;right:0;">
                        <button id="AddMWRefNoBtn" class="btn btn-default" type="button">Add</button>
                        <button id="MinusMWRefNoBtn" class="btn btn-default" type="button">Remove</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="navigator" class="w3-container w3-round-medium ">Details of the Building </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                @*<div class="w3-col l4 m12 s12">Address :</div>
                    <div class="w3-col l2 m12 s12">
                        @Html.TextAreaFor(model => model.P_MW_MODIFICATION.ADDRESS, new { @id = "ADDRESS" })

                    </div>*@
                <div class="w3-col l4 m12 s12">Lot No. :</div>
                <div class="w3-col l8 m12 s12">
                    @Html.TextBoxFor(model => model.P_MW_MODIFICATION.LOT_NO, new { @id = "LOT_NO" })
                    @*<input type="text" />*@
                </div>
            </div>
        </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">Address :</div>
                <div class="w3-col l8 m12 s12">
                    @Html.TextAreaFor(model => model.P_MW_MODIFICATION.ADDRESS, new { @id = "ADDRESS" })
                    @*<input type="text" />*@
                </div>
            </div>
        </div>
        <div id="navigator" class="w3-container w3-round-medium ">Details of the Modification and/or Exemption Sought  </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">《建築物條例》/ 規例 Buildings Ordinance / Regulations :</div>
                <div class="w3-col l2 m12 s12">
                    @Html.TextBoxFor(model => model.P_MW_MODIFICATION.REGULATIONS, new { @id = "REGULATIONS" })
                    @*<input type="text" />*@
                </div>
                <div class="w3-col l2 m12 s12">Type of Works</div>
                <div class="w3-col l3 m12 s12">
                    @*@Html.TextBoxFor(model => model.P_MW_MODIFICATION.IS_BUILDING_WORKS, new { @id = "REGULATIONS" })*@
                    @*<input type="text" />*@
                    @Html.DropDownListFor(model => model.WorkType, Model.WorkTypeList)
                    @*<select style="width:auto">
                            <option value="Y">Building works</option>
                            <option value="Y">Street works</option>
                        </select>*@
                </div>
            </div>
        </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">Description of Modification/Exemption Sought : </div>
                <div class="w3-col l7 m12 s12">
                    @Html.TextAreaFor(model => model.P_MW_MODIFICATION.DESC_OF_MODI, new { @id = "DESC_OF_MODI" })
                    @*<textarea></textarea>*@
                </div>
            </div>
        </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">Location of Subject and Drawing Number : </div>
                <div class="w3-col l7 m12 s12">
                    @Html.TextAreaFor(model => model.P_MW_MODIFICATION.LOC_OF_SUBJECT, new { @id = "LOC_OF_SUBJECT" })
                    @*<textarea></textarea>*@
                </div>
            </div>
        </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">
                    Special circumstances in connection <br>
                    with the said works in support of this application, <br />
                    including reasons for not being able to comply <br />
                    with the Buildings Ordinance/Regulations : <br />
                </div>
                <div class="w3-col l7 m12 s12">
                    @Html.TextAreaFor(model => model.P_MW_MODIFICATION.UNABLE_TO_COMPLY_REASON, new { @id = "UNABLE_TO_COMPLY_REASON" })
                    @*<textarea></textarea>*@
                </div>
            </div>
        </div>

        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">
                    Justifications, Proposed Remedies <br>
                    and Supporting Documents (if any) :
                </div>
                <div class="w3-col l7 m12 s12">
                    @Html.TextAreaFor(model => model.P_MW_MODIFICATION.SUPPORTING_DOCUMENT, new { @id = "SUPPORTING_DOCUMENT" })
                    @*<textarea></textarea>*@
                </div>
            </div>
        </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">Name of Applicant :</div>
                <div class="w3-col l2 m12 s12">
                    @Html.TextBoxFor(model => model.P_MW_MODIFICATION.APPLICANT_NAME, new { @id = "APPLICANT_NAME" })
                    @*<input type="text" />*@
                </div>
                <div class="w3-col l2 m12 s12">Received Date :</div>
                <div class="w3-col l3 m12 s12">
                    @Html.TextBoxFor(model => model.P_MW_MODIFICATION.RECEIVED_DATE, "", new { @id = "ReceivedDate", @class = "inputDate" })
                </div>
            </div>
        </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12"> Capacity of Applicant :</div>
                <div class="w3-col l2 m12 s12">
                    @Html.TextBoxFor(model => model.P_MW_MODIFICATION.APPLICANT_CAPACITY, new { @id = "APPLICANT_CAPACITY" })
                    @*<input type="text" />*@
                </div>
            </div>
        </div>
        <div class="w3-row">
            <div class="w3-col l12 m12 s12">
                <div class="w3-col l4 m12 s12">Handling staff (PO) :</div>
                <div class="w3-col l2 m12 s12">
                    @Html.TextBoxFor(model => model.P_MW_MODIFICATION.HANDING_STAFF)
                    @*<input type="text" />*@
                    @*@Html.DropDownListFor(model => model.HandingStaff, Model.HandingStaffList)*@
                    @*<select style="width:auto">
                            <option value="BS1">BS1</option>
                            <option value="SE4">SE4</option>
                            <option value="BS6">BS6</option>
                        </select>*@
                </div>
            </div>
        </div>

        <div class="w3-container footer">
            <button id="cancelBtn" class="cancelBtn btn btn-default" type="button" onclick="goTo('Index')" ><i class=""></i> Cancel</button>
            <button id="SubmitBtn" class="searchButton btn btn-default" type="button"><i class=""></i> Submit</button>
        </div>

    </div>
</form>
<div id="resultPanel"></div>

<script type="text/javascript">

    domReady(function () {
        attr("SubmitBtn", "onclick", { parameters: {}, callback: onSaveForm });
        attr("AddMWRefNoBtn", "onclick", { parameters: {}, callback: AddMWRefNoTB });
        attr("MinusMWRefNoBtn", "onclick", { parameters: {}, callback: MinusMWRefNoTB });
        attr("DSN", "onblur", { parameters: {}, callback: onBlurDSN });
    });

    // Begin Add by Chester 2019-07-02
    function onBlurDSN() {
        if ($("#DSN").val() != null && $("#DSN").val() != "" && $("#DSN").val() != undefined) {
            getMWNo($("#DSN").val());
        } else {
            $("#ModRefNo").text("");
            $("#refNo").val("");
        }

    }

    function getMWNo(dsn) {
        $.post("GetMWNo", { id: dsn }, function (data) {
            //attr("inputForm", "dropClass", "saving");
            if (data != null && data.Result != null && data.Result == "SUCCESS") {
                $("#ModRefNo").text(data.Message[0]);
                $("#refNo").val(data.Message[0]);
                $("#FormNoLb").text(data.Message[1]);
                $("#FormNo").val(data.Message[1]);
            }
            else {
                showErrorMessage(data.ErrorMessages);
                console.log(data);
            }
        }, "json");
    }

    /**
     * 根据参数名，获取url后面的参数的值
     * */
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) { return pair[1]; }
        }
        return null;
    }
    // End  Add by Chester 2019-07-02

    function onSaveForm(d, p, e) {
        attr("inputForm", "addClass", "saving");
        $.post("Create", $("#inputForm").serialize(), function (data) {
            attr("inputForm", "dropClass", "saving");
            if (data != null && data.Result != null && data.Result == "SUCCESS") {
                goTo("Form", null);
            }
            else {
                showErrorMessage(data.ErrorMessages);
            }
        }, "json");
    }

    function AddMWRefNoTB(d, p, e) {

        //Create new textbox
        var newTextBox = document.createElement("input");
        var ListTB = document.querySelectorAll("input[name^='MwRefNo']")

        //Set textbox attribute
        newTextBox.setAttribute("type", "text");
        newTextBox.setAttribute("id", "MwRefNo");
        newTextBox.setAttribute("name", "MwRefNo" + (ListTB.length + 1).toString());

        //add textbox to addPanel
        document.getElementById("AddPanel").appendChild(newTextBox);

        RefreshMinusBtn();

    }
    function MinusMWRefNoTB() {
        var ListTB = document.querySelectorAll("input[name^='MwRefNo']");
        var tb = document.getElementsByName("MwRefNo" + ListTB.length.toString());
        document.getElementById("AddPanel").removeChild(tb[0]);

        RefreshMinusBtn();
    }

    function RefreshMinusBtn() {
        //var ListTB = document.getElementsByName("newTextBox");
        var ListTB = document.querySelectorAll("input[name^='MwRefNo']")
        var minusBtn = document.getElementById("MinusMWRefNoBtn");
        if (ListTB.length == 3) {
            minusBtn.setAttribute("disabled", "true");
            minusBtn.setAttribute("hidden", "true");
        } else {
            minusBtn.removeAttribute("disabled");
            minusBtn.removeAttribute("hidden");
        }
    }

    RefreshMinusBtn();

    domReady(function () {
        var dsn = getQueryVariable('DSN');
        if (dsn != null && dsn != "" && dsn != undefined) {
            $("#DSN").val(dsn);
            getMWNo(dsn);
        }

        new searcher({
            searchPath: "SearchModOfToday"
            , exportPath: "ExcelBA16"
            , searchTable: "searchCriteria"
            , resultPanel: "resultPanel"
            , Columns: [
                { displayName: "Ref No.", columnName: "REFERENCE_NO" }
                , { displayName: "DSN No.", columnName: "DSN" }
                , { displayName: "Received Date", columnName: "RECEIVED_DATE" }
                , { displayName: "Handling staff (PO) ", columnName: "HANDING_STAFF" }
                , {
                    displayName: "&nbsp;", formater: function (row) {
                        return createButton("Edit", "fa-edit", [{
                            "onclick": {
                                parameters: { row: row }, callback: function (d, p, e) {
                                    if (row == null) return;
                                    goTo("EditForm", [{ name: "uuid", value: row.UUID }]);
                                }
                            }
                        }]);
                    }
                }
            ]
        }).search();
    });
</script>
